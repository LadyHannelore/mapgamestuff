<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Navy Battle Simulator - Map Game Mechanics</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
    <!-- Navigation Bar Placeholder moved to body -->
    <!-- GSAP Animation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    
    <style>
        /* Naval Combat Specific Styles */
        .ship-section {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(16, 185, 129, 0.1));
            border: 2px solid rgba(59, 130, 246, 0.2);
        }
        
        .fleet-a { border-color: rgba(147, 51, 234, 0.5); }
        .fleet-b { border-color: rgba(239, 68, 68, 0.5); }
        
        .range-indicator {
            background: linear-gradient(90deg, #3b82f6, #10b981);
            color: white;
            font-weight: bold;
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
            margin: 10px 0;
        }
        
        .damage-report {
            background: rgba(239, 68, 68, 0.1);
            border-left: 4px solid #ef4444;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }
        
        .ship-enhancement {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            display: inline-block;
            margin: 2px;
        }
        
        .combat-phase {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }
        
        .flag-indicator {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            display: inline-block;
            margin: 2px;
        }
        
        .flag-national { background: #3b82f6; color: white; }
        .flag-black { background: #1f2937; color: white; }
        .flag-white { background: #f3f4f6; color: #1f2937; border: 1px solid #d1d5db; }
        
        .gunnery-phase-counter {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin: 5px 0;
        }
        
        .combat-log {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .ship-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: bold;
            margin: 2px;
        }
        
        .ship-active { background: #10b981; color: white; }
        .ship-damaged { background: #f59e0b; color: white; }
        .ship-sunk { background: #ef4444; color: white; }
        .ship-captured { background: #8b5cf6; color: white; }
        
        /* Animation enhancements */
        .phase-reveal {
            opacity: 0;
            transform: translateY(20px);
            animation: revealPhase 0.8s ease-out forwards;
        }
        
        @keyframes revealPhase {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .battle-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(16, 185, 129, 0.1));
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 3px solid #e2e8f0;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hit-animation {
            animation: hitFlash 0.5s ease-out;
        }
        
        @keyframes hitFlash {
            0% { background-color: #ef4444; }
            50% { background-color: #fbbf24; }
            100% { background-color: transparent; }
        }
        
        .phase-counter {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            display: inline-block;
            margin: 10px 0;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .victory-announcement {
            animation: victoryFade 1s ease-out;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border: 3px solid #d97706;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        @keyframes victoryFade {
            0% { 
                opacity: 0; 
                transform: scale(0.8) translateY(-20px); 
            }
            100% { 
                opacity: 1; 
                transform: scale(1) translateY(0); 
            }
        }
        
        .ship-sink-animation {
            animation: sinkShip 1s ease-out;
        }
        
        @keyframes sinkShip {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            50% { transform: translateY(10px) rotate(-5deg); opacity: 0.7; }
            100% { transform: translateY(30px) rotate(-15deg); opacity: 0; }
        }
        
        .damage-impact {
            animation: damageShake 0.3s ease-out;
        }
        
        @keyframes damageShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .range-change {
            animation: rangeShift 0.5s ease-out;
        }
        
        @keyframes rangeShift {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        /* 2D Animation Styles */
        .battle-arena {
            background: linear-gradient(180deg, #3b82f6 0%, #1e40af 100%);
            border: 3px solid #1d4ed8;
            border-radius: 15px;
            position: relative;
            height: 300px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .sea-waves {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30px;
            background: repeating-linear-gradient(
                90deg,
                rgba(255,255,255,0.3) 0px,
                transparent 10px,
                rgba(255,255,255,0.3) 20px
            );
            animation: waveFlow 3s linear infinite;
        }
        
        @keyframes waveFlow {
            0% { transform: translateX(0); }
            100% { transform: translateX(20px); }
        }
        
        .ship {
            position: absolute;
            width: 60px;
            height: 30px;
            background: #8b4513;
            border-radius: 5px 20px 20px 5px;
            border: 2px solid #654321;
            transition: all 0.8s ease-in-out;
            z-index: 10;
        }
        
        .ship::before {
            content: '⛵';
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 20px;
            z-index: 11;
        }
        
        .ship-a {
            left: 50px;
            top: 100px;
            background: #9333ea;
            border-color: #7c3aed;
        }
        
        .ship-b {
            right: 50px;
            top: 170px;
            background: #dc2626;
            border-color: #b91c1c;
            transform: scaleX(-1);
        }
        
        .cannon-fire {
            position: absolute;
            width: 30px;
            height: 4px;
            background: linear-gradient(90deg, #fbbf24, #f59e0b, #dc2626);
            border-radius: 2px;
            opacity: 0;
            z-index: 15;
        }
        
        .cannon-smoke {
            position: absolute;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, rgba(128,128,128,0.8), transparent);
            border-radius: 50%;
            opacity: 0;
            z-index: 12;
        }
        
        .hit-explosion {
            position: absolute;
            width: 40px;
            height: 40px;
            background: radial-gradient(circle, #fbbf24, #f59e0b, #dc2626, transparent);
            border-radius: 50%;
            opacity: 0;
            z-index: 20;
            animation: explode 0.6s ease-out;
        }
        
        @keyframes explode {
            0% { 
                opacity: 1; 
                transform: scale(0.2); 
            }
            50% { 
                opacity: 1; 
                transform: scale(1.2); 
            }
            100% { 
                opacity: 0; 
                transform: scale(2); 
            }
        }
        
        .ship-maneuver-advance {
            animation: shipAdvance 1.5s ease-in-out;
        }
        
        .ship-maneuver-retreat {
            animation: shipRetreat 1.5s ease-in-out;
        }
        
        .ship-maneuver-hold {
            animation: shipHold 1s ease-in-out;
        }
        
        @keyframes shipAdvance {
            0%, 100% { transform: translateX(0) scaleX(1); }
            50% { transform: translateX(30px) scaleX(1); }
        }
        
        @keyframes shipRetreat {
            0%, 100% { transform: translateX(0) scaleX(1); }
            50% { transform: translateX(-30px) scaleX(1); }
        }
        
        @keyframes shipHold {
            0%, 100% { transform: translateY(0); }
            25% { transform: translateY(-5px); }
            75% { transform: translateY(5px); }
        }
        
        .cannon-fire-a {
            animation: fireCannonA 1s ease-out;
        }
        
        .cannon-fire-b {
            animation: fireCannonB 1s ease-out;
        }
        
        @keyframes fireCannonA {
            0% { 
                opacity: 1; 
                left: 110px; 
                width: 10px; 
            }
            50% { 
                opacity: 1; 
                left: 200px; 
                width: 20px; 
            }
            100% { 
                opacity: 0; 
                left: 300px; 
                width: 30px; 
            }
        }
        
        @keyframes fireCannonB {
            0% { 
                opacity: 1; 
                right: 110px; 
                width: 10px; 
            }
            50% { 
                opacity: 1; 
                right: 200px; 
                width: 20px; 
            }
            100% { 
                opacity: 0; 
                right: 300px; 
                width: 30px; 
            }
        }
        
        .ship-hit {
            animation: shipHit 0.8s ease-out;
        }
        
        @keyframes shipHit {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            25% { transform: translateX(-8px) rotate(-2deg); }
            75% { transform: translateX(8px) rotate(2deg); }
        }
        
        .ship-sinking {
            animation: shipSink 2s ease-in forwards;
        }
        
        @keyframes shipSink {
            0% { 
                transform: translateY(0) rotate(0deg); 
                opacity: 1; 
            }
            50% { 
                transform: translateY(20px) rotate(-10deg); 
                opacity: 0.7; 
            }
            100% { 
                transform: translateY(60px) rotate(-25deg); 
                opacity: 0; 
            }
        }
        
        .range-indicator-visual {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.9);
            padding: 5px 15px;
            border-radius: 15px;
            font-weight: bold;
            color: #1e40af;
            z-index: 25;
        }
        
        .boarding-animation {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 30px;
            opacity: 0;
            animation: boardingAction 2s ease-in-out;
            z-index: 30;
        }
        
        @keyframes boardingAction {
            0% { 
                opacity: 0; 
                transform: translate(-50%, -50%) scale(0.5); 
            }
            50% { 
                opacity: 1; 
                transform: translate(-50%, -50%) scale(1.2); 
            }
            100% { 
                opacity: 0; 
                transform: translate(-50%, -50%) scale(1); 
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="nav-placeholder"></div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            fetch('nav.html')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.text();
                })
                .then(data => {
                    document.getElementById('nav-placeholder').innerHTML = data;
                })
                .catch(error => {
                    console.error('Error loading navigation:', error);
                    document.getElementById('nav-placeholder').innerHTML = `
                        <nav class="bg-white shadow-lg">
                            <div class="container mx-auto px-4">
                                <div class="flex justify-between items-center py-4">
                                    <a href="index.html" class="text-xl font-bold text-blue-600">Map Game Mechanics</a>
                                    <div class="hidden md:flex space-x-6">
                                        <a href="index.html" class="text-gray-700 hover:text-blue-600">Home</a>
                                        <a href="map.html" class="text-gray-700 hover:text-blue-600">Map</a>
                                        <a href="warfare.html" class="text-gray-700 hover:text-blue-600">Warfare</a>
                                        <a href="battle-simulator.html" class="text-gray-700 hover:text-blue-600">Battle Sim</a>
                                        <a href="navy-battle-simulator.html" class="text-blue-600 font-semibold">Navy Sim</a>
                                    </div>
                                </div>
                            </div>
                        </nav>
                    `;
                });
        });
    </script>

    <div class="container mx-auto px-4 py-8">
        <div class="text-center mb-8 glassmorphism p-8 rounded-lg floating pulse-glow">
            <h1 class="hero-title">⛵ Navy Battle Simulator ⚔️</h1>
            <p class="text-xl gradient-text">Command the Seas, Control the Battle</p>
            <p class="text-sm mt-2 text-gray-600">Simulate naval combat based on the official naval warfare rules</p>
        </div>

        <!-- Fleet Setup -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Fleet A -->
            <div class="ship-section fleet-a p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4 text-purple-700">🏴‍☠️ Fleet A Setup</h2>
                
                <!-- Fleet A Name -->
                <div class="mb-4">
                    <label for="fleetAName" class="block text-sm font-medium mb-2">Fleet A Name:</label>
                    <input id="fleetAName" type="text" placeholder="Enter fleet name" class="w-full border p-2 rounded" value="Royal Navy" />
                </div>
                
                <!-- Admiral A Setup -->
                <div class="mb-6 p-4 bg-white rounded-lg border border-purple-200">
                    <h4 class="font-semibold mb-3 text-purple-600">Admiral A</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="admiralAName" class="block text-sm font-medium mb-2">Admiral Name:</label>
                            <input id="admiralAName" type="text" placeholder="Enter admiral name" class="w-full border p-2 rounded" value="Admiral Nelson" />
                        </div>
                        <div>
                            <label for="admiralALevel" class="block text-sm font-medium mb-2">Admiral Level:</label>
                            <input id="admiralALevel" type="number" min="1" max="10" value="1" class="w-full border p-2 rounded" />
                        </div>
                    </div>
                </div>
                
                <!-- Fleet A Ship Controls -->
                <div class="border-t-2 border-purple-200 pt-4 bg-white rounded-lg p-4">
                    <h4 class="font-semibold mb-3 text-purple-600">Add Ships to Fleet A:</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3 mb-4">
                        <select id="shipTypeA" class="border p-2 rounded text-sm">
                            <option value="Galley">Galley</option>
                            <option value="Corvette">Corvette</option>
                            <option value="Frigate">Frigate</option>
                            <option value="Ship of the Line">Ship of the Line</option>
                        </select>
                        <select id="enhancementA" class="border p-2 rounded text-sm">
                            <option value="None">No Enhancement</option>
                            <option value="Additional Firepower">Additional Firepower (+2 gunnery)</option>
                            <option value="Additional Propulsion">Additional Propulsion (+1 move, +1 maneuver)</option>
                            <option value="Camouflage">Camouflage (+2 to spot requirement)</option>
                            <option value="Debris Netting">Debris Netting (salvage resources)</option>
                            <option value="Experienced Spotters">Experienced Spotters (2 dice spotting)</option>
                            <option value="False Flags">False Flags (disguise capability)</option>
                            <option value="Marine Detachment">Marine Detachment (+2 boarding)</option>
                            <option value="Reinforced Hulls">Reinforced Hulls (+1 damage report)</option>
                        </select>
                        <select id="flagA" class="border p-2 rounded text-sm">
                            <option value="Royal Navy">Royal Navy</option>
                            <option value="Pirate Fleet">Pirate Fleet</option>
                            <option value="Merchant Marine">Merchant Marine</option>
                            <option value="National">National Flags</option>
                            <option value="Black">Black Flags (Pirate)</option>
                            <option value="White">White Flags (Surrender)</option>
                        </select>
                        <input id="shipCountA" type="number" min="1" max="20" value="1" class="border p-2 rounded" />
                        <button id="addShipA" class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 font-medium">Add Ships</button>
                    </div>
                </div>
                
                <!-- Fleet A List -->
                <div class="mt-4">
                    <h4 class="font-semibold mb-2">Fleet A Ships:</h4>
                    <div class="bg-white rounded border overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-purple-50">
                                <tr>
                                    <th class="text-left p-2 border-b">Ship Type</th>
                                    <th class="text-left p-2 border-b">Enhancement</th>
                                    <th class="text-left p-2 border-b">Flags</th>
                                    <th class="text-left p-2 border-b">Status</th>
                                    <th class="text-left p-2 border-b">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="fleetAList">
                                <!-- Ships will be added here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Fleet B -->
            <div class="ship-section fleet-b p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4 text-red-700">⚓ Fleet B Setup</h2>
                
                <!-- Fleet B Name -->
                <div class="mb-4">
                    <label for="fleetBName" class="block text-sm font-medium mb-2">Fleet B Name:</label>
                    <input id="fleetBName" type="text" placeholder="Enter fleet name" class="w-full border p-2 rounded" value="Enemy Fleet" />
                </div>
                
                <!-- Admiral B Setup -->
                <div class="mb-6 p-4 bg-white rounded-lg border border-red-200">
                    <h4 class="font-semibold mb-3 text-red-600">Admiral B</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="admiralBName" class="block text-sm font-medium mb-2">Admiral Name:</label>
                            <input id="admiralBName" type="text" placeholder="Enter admiral name" class="w-full border p-2 rounded" value="Captain Blackbeard" />
                        </div>
                        <div>
                            <label for="admiralBLevel" class="block text-sm font-medium mb-2">Admiral Level:</label>
                            <input id="admiralBLevel" type="number" min="1" max="10" value="1" class="w-full border p-2 rounded" />
                        </div>
                    </div>
                </div>
                
                <!-- Fleet B Ship Controls -->
                <div class="border-t-2 border-red-200 pt-4 bg-white rounded-lg p-4">
                    <h4 class="font-semibold mb-3 text-red-600">Add Ships to Fleet B:</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3 mb-4">
                        <select id="shipTypeB" class="border p-2 rounded text-sm">
                            <option value="Galley">Galley</option>
                            <option value="Corvette">Corvette</option>
                            <option value="Frigate">Frigate</option>
                            <option value="Ship of the Line">Ship of the Line</option>
                        </select>
                        <select id="enhancementB" class="border p-2 rounded text-sm">
                            <option value="None">No Enhancement</option>
                            <option value="Additional Firepower">Additional Firepower (+2 gunnery)</option>
                            <option value="Additional Propulsion">Additional Propulsion (+1 move, +1 maneuver)</option>
                            <option value="Camouflage">Camouflage (+2 to spot requirement)</option>
                            <option value="Debris Netting">Debris Netting (salvage resources)</option>
                            <option value="Experienced Spotters">Experienced Spotters (2 dice spotting)</option>
                            <option value="False Flags">False Flags (disguise capability)</option>
                            <option value="Marine Detachment">Marine Detachment (+2 boarding)</option>
                            <option value="Reinforced Hulls">Reinforced Hulls (+1 damage report)</option>
                        </select>
                        <select id="flagB" class="border p-2 rounded text-sm">
                            <option value="Pirate Fleet">Pirate Fleet</option>
                            <option value="Royal Navy">Royal Navy</option>
                            <option value="Merchant Marine">Merchant Marine</option>
                            <option value="National">National Flags</option>
                            <option value="Black">Black Flags (Pirate)</option>
                            <option value="White">White Flags (Surrender)</option>
                        </select>
                        <input id="shipCountB" type="number" min="1" max="20" value="1" class="border p-2 rounded" />
                        <button id="addShipB" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 font-medium">Add Ships</button>
                    </div>
                </div>
                
                <!-- Fleet B List -->
                <div class="mt-4">
                    <h4 class="font-semibold mb-2">Fleet B Ships:</h4>
                    <div class="bg-white rounded border overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-red-50">
                                <tr>
                                    <th class="text-left p-2 border-b">Ship Type</th>
                                    <th class="text-left p-2 border-b">Enhancement</th>
                                    <th class="text-left p-2 border-b">Flags</th>
                                    <th class="text-left p-2 border-b">Status</th>
                                    <th class="text-left p-2 border-b">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="fleetBList">
                                <!-- Ships will be added here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ship Type Reference -->
        <div class="glassmorphism card fade-in p-6 rounded-lg mb-8">
            <h2 class="text-2xl font-bold mb-4 text-center text-blue-600">🚢 Ship Type Reference</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-white p-4 rounded-lg border-2 border-blue-200">
                    <h3 class="text-lg font-bold text-blue-700 mb-2">⛵ Galley</h3>
                    <div class="text-sm space-y-1">
                        <p><strong>Cost:</strong> 3 Material, 1 Fuel</p>
                        <p><strong>Gunnery:</strong> 2</p>
                        <p><strong>Maneuver:</strong> 4</p>
                        <p><strong>Damage Report:</strong> 3</p>
                        <p><strong>Movement:</strong> 3</p>
                        <p class="text-gray-600 mt-2">Fast and agile but lightly armed</p>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg border-2 border-green-200">
                    <h3 class="text-lg font-bold text-green-700 mb-2">🚢 Corvette</h3>
                    <div class="text-sm space-y-1">
                        <p><strong>Cost:</strong> 5 Material, 2 Fuel</p>
                        <p><strong>Gunnery:</strong> 4</p>
                        <p><strong>Maneuver:</strong> 3</p>
                        <p><strong>Damage Report:</strong> 4</p>
                        <p><strong>Movement:</strong> 4</p>
                        <p class="text-gray-600 mt-2">Balanced warship, good speed</p>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg border-2 border-orange-200">
                    <h3 class="text-lg font-bold text-orange-700 mb-2">⚓ Frigate</h3>
                    <div class="text-sm space-y-1">
                        <p><strong>Cost:</strong> 8 Material, 3 Fuel</p>
                        <p><strong>Gunnery:</strong> 6</p>
                        <p><strong>Maneuver:</strong> 2</p>
                        <p><strong>Damage Report:</strong> 5</p>
                        <p><strong>Movement:</strong> 3</p>
                        <p class="text-gray-600 mt-2">Heavy firepower, moderate speed</p>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg border-2 border-red-200">
                    <h3 class="text-lg font-bold text-red-700 mb-2">🚢 Ship of the Line</h3>
                    <div class="text-sm space-y-1">
                        <p><strong>Cost:</strong> 12 Material, 5 Fuel</p>
                        <p><strong>Gunnery:</strong> 8</p>
                        <p><strong>Maneuver:</strong> 1</p>
                        <p><strong>Damage Report:</strong> 6</p>
                        <p><strong>Movement:</strong> 2</p>
                        <p class="text-gray-600 mt-2">Massive firepower but slow</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Moderator Control Panel -->
        <div class="glassmorphism card fade-in p-6 rounded-lg mb-8">
            <h2 class="text-2xl font-bold mb-4 text-center text-orange-600">🎯 Moderator Control Panel</h2>
            <p class="text-center text-gray-600 mb-6">Apply external bonuses/penalties during battle (weather, tactics, divine intervention, etc.)</p>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Fleet A Modifiers -->
                <div class="bg-white rounded-lg p-4 border-2 border-purple-200">
                    <h3 class="text-lg font-semibold mb-4 text-purple-700">🏴‍☠️ Fleet A External Modifiers</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="modFleetAManeuver" class="block text-sm font-medium mb-2">Maneuver Modifier:</label>
                            <div class="flex items-center">
                                <input id="modFleetAManeuver" type="number" value="0" min="-10" max="10" class="w-full border p-2 rounded text-center" />
                                <span class="ml-2 text-xs text-gray-500">±10</span>
                            </div>
                        </div>
                        <div>
                            <label for="modFleetAGunnery" class="block text-sm font-medium mb-2">Gunnery Modifier:</label>
                            <div class="flex items-center">
                                <input id="modFleetAGunnery" type="number" value="0" min="-10" max="10" class="w-full border p-2 rounded text-center" />
                                <span class="ml-2 text-xs text-gray-500">±10</span>
                            </div>
                        </div>
                        <div>
                            <label for="modFleetABoarding" class="block text-sm font-medium mb-2">Boarding Modifier:</label>
                            <div class="flex items-center">
                                <input id="modFleetABoarding" type="number" value="0" min="-10" max="10" class="w-full border p-2 rounded text-center" />
                                <span class="ml-2 text-xs text-gray-500">±10</span>
                            </div>
                        </div>
                        <div>
                            <label for="modFleetADamage" class="block text-sm font-medium mb-2">Damage Report Modifier:</label>
                            <div class="flex items-center">
                                <input id="modFleetADamage" type="number" value="0" min="-10" max="10" class="w-full border p-2 rounded text-center" />
                                <span class="ml-2 text-xs text-gray-500">±10</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <label for="modFleetAReason" class="block text-sm font-medium mb-2">Reason for Modifiers:</label>
                        <input id="modFleetAReason" type="text" placeholder="e.g., Favorable winds, Divine blessing, Superior tactics..." class="w-full border p-2 rounded text-sm" />
                    </div>
                </div>

                <!-- Fleet B Modifiers -->
                <div class="bg-white rounded-lg p-4 border-2 border-red-200">
                    <h3 class="text-lg font-semibold mb-4 text-red-700">⚓ Fleet B External Modifiers</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="modFleetBManeuver" class="block text-sm font-medium mb-2">Maneuver Modifier:</label>
                            <div class="flex items-center">
                                <input id="modFleetBManeuver" type="number" value="0" min="-10" max="10" class="w-full border p-2 rounded text-center" />
                                <span class="ml-2 text-xs text-gray-500">±10</span>
                            </div>
                        </div>
                        <div>
                            <label for="modFleetBGunnery" class="block text-sm font-medium mb-2">Gunnery Modifier:</label>
                            <div class="flex items-center">
                                <input id="modFleetBGunnery" type="number" value="0" min="-10" max="10" class="w-full border p-2 rounded text-center" />
                                <span class="ml-2 text-xs text-gray-500">±10</span>
                            </div>
                        </div>
                        <div>
                            <label for="modFleetBBoarding" class="block text-sm font-medium mb-2">Boarding Modifier:</label>
                            <div class="flex items-center">
                                <input id="modFleetBBoarding" type="number" value="0" min="-10" max="10" class="w-full border p-2 rounded text-center" />
                                <span class="ml-2 text-xs text-gray-500">±10</span>
                            </div>
                        </div>
                        <div>
                            <label for="modFleetBDamage" class="block text-sm font-medium mb-2">Damage Report Modifier:</label>
                            <div class="flex items-center">
                                <input id="modFleetBDamage" type="number" value="0" min="-10" max="10" class="w-full border p-2 rounded text-center" />
                                <span class="ml-2 text-xs text-gray-500">±10</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <label for="modFleetBReason" class="block text-sm font-medium mb-2">Reason for Modifiers:</label>
                        <input id="modFleetBReason" type="text" placeholder="e.g., Storm interference, Cursed crew, Poor navigation..." class="w-full border p-2 rounded text-sm" />
                    </div>
                </div>
            </div>

            <!-- Moderator Controls -->
            <div class="mt-6 text-center">
                <div class="flex flex-wrap justify-center gap-4">
                    <button id="applyModifiers" class="px-4 py-2 bg-orange-600 text-white rounded-lg font-bold shadow-lg hover:bg-orange-700 transition-all duration-300">
                        <i class="fas fa-magic mr-2"></i>Apply Modifiers
                    </button>
                    <button id="clearModifiers" class="px-4 py-2 bg-gray-600 text-white rounded-lg font-bold shadow-lg hover:bg-gray-700 transition-all duration-300">
                        <i class="fas fa-eraser mr-2"></i>Clear All Modifiers
                    </button>
                    <button id="randomEvent" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-bold shadow-lg hover:from-purple-700 hover:to-blue-700 transition-all duration-300">
                        <i class="fas fa-dice mr-2"></i>Random Event
                    </button>
                </div>
                <div id="modifierStatus" class="mt-4 text-sm text-gray-600">
                    No external modifiers currently applied
                </div>
            </div>
        </div>

        <!-- Battle Controls -->
        <div class="glassmorphism card fade-in p-6 rounded-lg mb-8">
            <h2 class="text-2xl font-bold mb-4 text-center">⚔️ Naval Combat Controls</h2>
            <div class="flex flex-wrap justify-center gap-4">
                <button id="simulateNavalBattle" class="px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg font-bold shadow-lg hover:from-blue-700 hover:to-blue-800 transition-all duration-300">
                    <i class="fas fa-anchor mr-2"></i>Simulate Naval Battle
                </button>
                <button id="newNavalBattle" class="px-6 py-3 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-lg font-bold shadow-lg hover:from-green-700 hover:to-green-800 transition-all duration-300">
                    <i class="fas fa-ship mr-2"></i>New Battle
                </button>
                <button id="generateNavalReport" class="px-6 py-3 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-lg font-bold shadow-lg hover:from-purple-700 hover:to-purple-800 transition-all duration-300">
                    <i class="fas fa-scroll mr-2"></i>Generate Report
                </button>
            </div>
        </div>

        <!-- 2D Battle Arena -->
        <div id="battleArena" class="glassmorphism card fade-in p-6 rounded-lg mb-8" style="display: none;">
            <h2 class="text-2xl font-bold mb-4 text-center">🌊 Battle Arena 🌊</h2>
            <div class="relative bg-gradient-to-b from-blue-300 via-blue-500 to-blue-700 rounded-lg overflow-hidden" style="height: 400px;">
                <!-- Ocean waves background -->
                <div class="absolute inset-0 opacity-30">
                    <div class="wave wave1"></div>
                    <div class="wave wave2"></div>
                    <div class="wave wave3"></div>
                </div>
                
                <!-- Range indicators -->
                <div class="absolute top-2 left-2 right-2 flex justify-between text-white text-sm font-bold">
                    <span id="rangeDisplay" class="bg-black bg-opacity-50 px-2 py-1 rounded">Range: 2</span>
                    <span id="phaseDisplay" class="bg-black bg-opacity-50 px-2 py-1 rounded">Phase: Setup</span>
                </div>
                
                <!-- Fleet A ships (left side) -->
                <div id="fleetAShips" class="absolute left-8 top-1/2 transform -translate-y-1/2 space-y-4">
                    <!-- Ships will be dynamically added here -->
                </div>
                
                <!-- Fleet B ships (right side) -->
                <div id="fleetBShips" class="absolute right-8 top-1/2 transform -translate-y-1/2 space-y-4">
                    <!-- Ships will be dynamically added here -->
                </div>
                
                <!-- Combat effects container -->
                <div id="combatEffects" class="absolute inset-0 pointer-events-none">
                    <!-- Cannon fire, explosions, etc. will appear here -->
                </div>
            </div>
        </div>

        <!-- Battle Results -->
        <div id="navalBattleResult" class="combat-log min-h-48 mb-8">
            <div class="text-center text-gray-500 py-8">
                <i class="fas fa-ship text-4xl mb-4"></i>
                <p>Set up your fleets and click "Simulate Naval Battle" to begin the engagement!</p>
                <p class="text-sm mt-2">⚠️ Remember: Combat is limited to 10 Gunnery phases maximum</p>
            </div>
        </div>
    </div>

    <script>
        // Global variables for fleets and external modifiers
        window.fleetA = [];
        window.fleetB = [];
        
        // External modifiers from moderator
        window.externalModifiers = {
            fleetA: { maneuver: 0, gunnery: 0, boarding: 0, damage: 0, reason: '' },
            fleetB: { maneuver: 0, gunnery: 0, boarding: 0, damage: 0, reason: '' }
        };
        
        // Ship enhancement effects
        const SHIP_ENHANCEMENTS = {
            'Additional Firepower': { gunnery: 2 },
            'Additional Propulsion': { move: 1, maneuver: 1 },
            'Camouflage': { spotRequirement: 2 },
            'Debris Netting': { salvage: true },
            'Experienced Spotters': { spotDice: 2 },
            'False Flags': { disguise: true },
            'Marine Detachment': { boarding: 2, pirateProtection: 0.5 },
            'Reinforced Hulls': { damageReport: 1 }
        };

        // Current battle state
        let currentBattle = {
            range: 2, // All battles start at Range 2
            gunneryPhase: 0,
            maxGunneryPhases: 10,
            fleetAShips: [],
            fleetBShips: [],
            battleLog: []
        };

        // Define ship type stats
        function getShipStats(shipType) {
            const stats = {
                'Galley': { gunnery: 2, maneuver: 4, damageReport: 3, movement: 3 },
                'Corvette': { gunnery: 4, maneuver: 3, damageReport: 4, movement: 4 },
                'Frigate': { gunnery: 6, maneuver: 2, damageReport: 5, movement: 3 },
                'Ship of the Line': { gunnery: 8, maneuver: 1, damageReport: 6, movement: 2 }
            };
            return stats[shipType] || stats['Galley'];
        }

        // Add ships to fleet
        function addShipsToFleet(fleet, listElement, shipType, enhancement, flag, count) {
            console.log('Adding ships to fleet:', { fleet, shipType, enhancement, flag, count });
            for (let i = 0; i < count; i++) {
                const ship = {
                    id: fleet.length + i + 1,
                    type: shipType || 'Galley',
                    enhancement: enhancement || 'None',
                    flag: flag,
                    status: 'Active',
                    damageReports: [],
                    gunneryModifier: 0,
                    maneuverModifier: 0,
                    boardingModifier: 0,
                    damageReportModifier: 0
                };
                
                // Apply ship type base stats
                const shipStats = getShipStats(shipType);
                ship.baseGunnery = shipStats.gunnery;
                ship.baseManeuver = shipStats.maneuver;
                ship.baseDamageReport = shipStats.damageReport;
                ship.movementPoints = shipStats.movement;
                
                // Apply enhancement effects
                if (enhancement && SHIP_ENHANCEMENTS[enhancement]) {
                    const effects = SHIP_ENHANCEMENTS[enhancement];
                    ship.gunneryModifier += effects.gunnery || 0;
                    ship.maneuverModifier += effects.maneuver || 0;
                    ship.boardingModifier += effects.boarding || 0;
                    ship.damageReportModifier += effects.damageReport || 0;
                }
                
                fleet.push(ship);
            }
            console.log('Updated fleet:', fleet);
            renderFleet(listElement, fleet);
        }

        // Render fleet display
        function renderFleet(listElement, fleet) {
            listElement.innerHTML = '';
            const fleetId = listElement.id.includes('fleetA') ? 'A' : 'B';
            
            fleet.forEach((ship, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                
                row.innerHTML = `
                    <td class="p-2">
                        <span class="font-medium text-blue-700">${ship.type || 'Galley'}</span>
                    </td>
                    <td class="p-2">
                        ${ship.enhancement !== 'None' ? `<span class="ship-enhancement">${ship.enhancement}</span>` : 'No Enhancement'}
                    </td>
                    <td class="p-2">
                        <span class="flag-indicator flag-${ship.flag.toLowerCase()}">${ship.flag}</span>
                    </td>
                    <td class="p-2">
                        <span class="ship-status ship-${ship.status.toLowerCase()}">${ship.status}</span>
                    </td>
                    <td class="p-2">
                        <button onclick="removeShip(${index}, '${fleetId}')" class="px-2 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </td>
                `;
                
                listElement.appendChild(row);
            });
        }

        // Remove ship from fleet
        function removeShip(index, fleetId) {
            const fleet = fleetId === 'A' ? window.fleetA : window.fleetB;
            const listElement = document.getElementById(`fleet${fleetId}List`);
            fleet.splice(index, 1);
            renderFleet(listElement, fleet);
        }

        // Roll dice
        function rollD6() {
            return Math.floor(Math.random() * 6) + 1;
        }

        // Spotting check
        function spotCheck(ship1, ship2) {
            let requiredRoll = 4; // Base requirement is 4-6
            
            // Apply camouflage modifier
            if (ship2.enhancement === 'Camouflage') {
                requiredRoll += 2;
            }
            
            let dice = 1;
            if (ship1.enhancement === 'Experienced Spotters') {
                dice = 2;
            }
            
            let spotted = false;
            for (let i = 0; i < dice; i++) {
                const roll = rollD6();
                if (roll >= requiredRoll) {
                    spotted = true;
                    break;
                }
            }
            
            return spotted;
        }

        // Maneuver phase with external modifiers
        function maneuverPhase(shipA, shipB) {
            // Check for auto-fail conditions (Hull Breach damage)
            const shipAAutoFail = shipA.maneuverModifier <= -100; // Hull Breach auto-fail
            const shipBAutoFail = shipB.maneuverModifier <= -100; // Hull Breach auto-fail
            
            let rollA, rollB;
            
            if (shipAAutoFail) {
                rollA = 0; // Auto-fail shows as 0
                shipA.maneuverModifier = 0; // Reset after use
            } else {
                rollA = rollD6() + shipA.maneuverModifier + window.externalModifiers.fleetA.maneuver;
            }
            
            if (shipBAutoFail) {
                rollB = 0; // Auto-fail shows as 0
                shipB.maneuverModifier = 0; // Reset after use
            } else {
                rollB = rollD6() + shipB.maneuverModifier + window.externalModifiers.fleetB.maneuver;
            }
            
            let winner, action;
            if (rollA > rollB) {
                winner = 'A';
            } else if (rollB > rollA) {
                winner = 'B';
            } else {
                return { winner: 'tie', action: 'hold', rollA, rollB, shipAAutoFail, shipBAutoFail };
            }
            
            // Winner decides action (for simulation, use random choice)
            const actions = ['advance', 'retreat', 'hold'];
            action = actions[Math.floor(Math.random() * actions.length)];
            
            // Apply action to range
            if (action === 'advance' && currentBattle.range > 0) {
                currentBattle.range--;
            } else if (action === 'retreat' && currentBattle.range < 4) {
                currentBattle.range++;
            }
            
            return { winner, action, rollA, rollB, shipAAutoFail, shipBAutoFail };
        }

        // Gunnery phase with external modifiers
        function gunneryPhase(shipA, shipB) {
            const range = currentBattle.range;
            let modifierA = shipA.gunneryModifier + window.externalModifiers.fleetA.gunnery;
            let modifierB = shipB.gunneryModifier + window.externalModifiers.fleetB.gunnery;
            
            // Range bonuses
            if (range === 1) {
                modifierA += 2;
                modifierB += 2;
            } else if (range === 2) {
                modifierA += 1;
                modifierB += 1;
            }
            
            const rollA = rollD6() + modifierA;
            const rollB = rollD6() + modifierB;
            
            const hitA = rollA >= 5;
            const hitB = rollB >= 5;
            
            let damageA = null, damageB = null;
            
            if (hitA) {
                damageB = damageReport(shipB);
                shipB.damageReports.push(damageB);
            }
            
            if (hitB) {
                damageA = damageReport(shipA);
                shipA.damageReports.push(damageA);
            }
            
            return {
                rollA, rollB, hitA, hitB, damageA, damageB,
                modifierA, modifierB
            };
        }

        // Damage report with external modifiers
        function damageReport(ship) {
            const fleet = currentBattle.fleetAShips.includes(ship) ? 'fleetA' : 'fleetB';
            let roll = rollD6() + ship.damageReportModifier + window.externalModifiers[fleet].damage;
            
            const damageTypes = {
                7: { name: 'Glancing Blow', effect: 'No effect' },
                6: { name: 'Glancing Blow', effect: 'No effect' },
                5: { name: 'Blasted Deck', effect: '-1 to next boarding check' },
                4: { name: 'Ammunition Strike', effect: '-2 to next gunnery check' },
                3: { name: 'Raking Fire', effect: '-1 to next damage report' },
                2: { name: 'Hull Breach', effect: 'Auto-fail next maneuver, -2 to next damage report' },
                1: { name: 'Critical Hit', effect: '-4 to next damage report' },
                0: { name: 'Kill Shot', effect: 'Ship sinks' }
            };
            
            // Apply damage effects
            const damage = damageTypes[Math.min(roll, 7)] || damageTypes[0];
            
            if (roll <= 0) {
                ship.status = 'Sunk';
            } else if (roll === 1) {
                ship.damageReportModifier -= 4;
            } else if (roll === 2) {
                ship.maneuverModifier = -999; // Auto-fail next maneuver (marker value)
                ship.damageReportModifier -= 2;
            } else if (roll === 3) {
                ship.damageReportModifier -= 1;
            } else if (roll === 4) {
                ship.gunneryModifier -= 2;
            } else if (roll === 5) {
                ship.boardingModifier -= 1;
            }
            
            return { roll, ...damage };
        }

        // Boarding phase
        function boardingPhase(shipA, shipB) {
            const rollA = rollD6() + shipA.boardingModifier;
            const rollB = rollD6() + shipB.boardingModifier;
            
            let winner = null;
            if (Math.abs(rollA - rollB) >= 3) {
                winner = rollA > rollB ? 'A' : 'B';
                if (winner === 'A') {
                    shipB.status = 'Captured';
                } else {
                    shipA.status = 'Captured';
                }
            }
            
            return { rollA, rollB, winner };
        }

        // Enhanced 2D Animation Functions
        
        // Initialize battle arena with ships
        function initializeBattleArena() {
            const arena = document.getElementById('battleArena');
            if (!arena) return;
            
            const fleetAContainer = document.getElementById('fleetAShips');
            const fleetBContainer = document.getElementById('fleetBShips');
            
            // Clear existing ships
            fleetAContainer.innerHTML = '';
            fleetBContainer.innerHTML = '';
            
            // Add Fleet A ships (left side)
            currentBattle.fleetAShips.forEach((ship, index) => {
                if (ship.status !== 'sunk') {
                    const shipElement = createShipElement(ship, 'fleet-a', index);
                    fleetAContainer.appendChild(shipElement);
                }
            });
            
            // Add Fleet B ships (right side)
            currentBattle.fleetBShips.forEach((ship, index) => {
                if (ship.status !== 'sunk') {
                    const shipElement = createShipElement(ship, 'fleet-b', index);
                    fleetBContainer.appendChild(shipElement);
                }
            });
            
            // Show arena
            arena.style.display = 'block';
            arena.scrollIntoView({ behavior: 'smooth' });
        }

        // Create visual ship element
        function createShipElement(ship, fleetClass, index) {
            const shipDiv = document.createElement('div');
            shipDiv.className = `battle-ship ${fleetClass}`;
            shipDiv.id = `${fleetClass}-ship-${index}`;
            shipDiv.setAttribute('data-ship-index', index);
            
            // Add health bar
            const healthBar = document.createElement('div');
            healthBar.className = 'ship-health-bar';
            const healthFill = document.createElement('div');
            healthFill.className = 'ship-health-fill';
            healthFill.style.width = '100%';
            healthBar.appendChild(healthFill);
            shipDiv.appendChild(healthBar);
            
            // Add ship name
            const shipName = document.createElement('div');
            shipName.className = 'ship-name';
            shipName.textContent = ship.id || `Ship ${index + 1}`;
            shipDiv.appendChild(shipName);
            
            return shipDiv;
        }

        // Update ship health visually
        function updateShipHealth(fleetClass, shipIndex, ship) {
            const shipElement = document.getElementById(`${fleetClass}-ship-${shipIndex}`);
            if (!shipElement) return;
            
            const healthFill = shipElement.querySelector('.ship-health-fill');
            const maxHP = ship.structure || 3;
            const currentHP = Math.max(0, maxHP - ship.damageReports.length);
            const healthPercent = (currentHP / maxHP) * 100;
            
            healthFill.style.width = `${healthPercent}%`;
            
            // Update health bar color based on damage
            healthFill.className = 'ship-health-fill';
            if (healthPercent <= 25) {
                healthFill.classList.add('critical');
            } else if (healthPercent <= 50) {
                healthFill.classList.add('damaged');
            }
        }

        // Enhanced maneuver animation with GSAP
        function animateManeuver(winner, action, shipA, shipB) {
            const fleetAShips = document.querySelectorAll('.battle-ship.fleet-a');
            const fleetBShips = document.querySelectorAll('.battle-ship.fleet-b');
            const allShips = [...fleetAShips, ...fleetBShips];
            
            // Update phase display with GSAP animation
            updatePhaseDisplay('Maneuver Phase');
            
            // GSAP Timeline for coordinated ship movements
            const tl = gsap.timeline();
            
            // Animate all ships maneuvering with staggered timing
            tl.to(allShips.filter(ship => !ship.classList.contains('sinking')), {
                rotation: "+=10",
                x: "+=20",
                duration: 0.3,
                ease: "power2.inOut",
                stagger: 0.1
            })
            .to(allShips.filter(ship => !ship.classList.contains('sinking')), {
                rotation: "-=20",
                x: "-=40",
                duration: 0.4,
                ease: "power2.inOut",
                stagger: 0.1
            }, "+=0.1")
            .to(allShips.filter(ship => !ship.classList.contains('sinking')), {
                rotation: "+=10",
                x: "+=20",
                duration: 0.3,
                ease: "power2.out",
                stagger: 0.1
            }, "+=0.1");
            
            // Add water splash effects during maneuvering
            tl.call(() => {
                allShips.forEach((ship, index) => {
                    if (!ship.classList.contains('sinking')) {
                        setTimeout(() => createWaterSplash(ship), index * 100);
                    }
                });
            }, null, "+=0.2");
        }

        // Enhanced gunnery animation with GSAP cannon fire
        function animateGunnery(hitA, hitB, shipA, shipB) {
            const fleetAShips = document.querySelectorAll('.battle-ship.fleet-a');
            const fleetBShips = document.querySelectorAll('.battle-ship.fleet-b');
            
            updatePhaseDisplay('Gunnery Phase');
            
            // GSAP Timeline for coordinated gunnery sequence
            const tl = gsap.timeline();
            
            // Fleet A fires first
            if (fleetAShips.length > 0) {
                const shipA = fleetAShips[0];
                
                // Cannon recoil animation
                tl.to(shipA, {
                    x: "-=15",
                    rotation: "-=5",
                    duration: 0.2,
                    ease: "power2.out"
                })
                .to(shipA, {
                    x: "+=15",
                    rotation: "+=5",
                    duration: 0.3,
                    ease: "bounce.out"
                });
                
                // Create muzzle flash effect
                tl.call(() => createMuzzleFlash(shipA), null, "-=0.4");
                
                // If hit, create explosion and damage
                if (hitA && fleetBShips.length > 0) {
                    tl.call(() => {
                        createExplosion(fleetBShips[0]);
                        animateShipDamage('fleet-b', 0);
                        updateShipHealth('fleet-b', 0, shipB);
                        
                        if (shipB.status === 'sunk') {
                            setTimeout(() => animateShipSinking('fleet-b', 0), 500);
                        }
                    }, null, "+=0.3");
                }
            }
            
            // Fleet B fires back
            if (fleetBShips.length > 0) {
                const shipB = fleetBShips[0];
                
                // Cannon recoil animation
                tl.to(shipB, {
                    x: "+=15",
                    rotation: "+=5",
                    duration: 0.2,
                    ease: "power2.out"
                }, "+=0.5")
                .to(shipB, {
                    x: "-=15",
                    rotation: "-=5",
                    duration: 0.3,
                    ease: "bounce.out"
                });
                
                // Create muzzle flash effect
                tl.call(() => createMuzzleFlash(shipB), null, "-=0.4");
                
                // If hit, create explosion and damage
                if (hitB && fleetAShips.length > 0) {
                    tl.call(() => {
                        createExplosion(fleetAShips[0]);
                        animateShipDamage('fleet-a', 0);
                        updateShipHealth('fleet-a', 0, shipA);
                        
                        if (shipA.status === 'sunk') {
                            setTimeout(() => animateShipSinking('fleet-a', 0), 500);
                        }
                    }, null, "+=0.3");
                }
            }
        }

        // Enhanced boarding animation with GSAP
        function animateBoarding() {
            const fleetAShips = document.querySelectorAll('.battle-ship.fleet-a');
            const fleetBShips = document.querySelectorAll('.battle-ship.fleet-b');
            
            updatePhaseDisplay('Boarding Phase');
            
            // GSAP Timeline for boarding sequence
            const tl = gsap.timeline();
            
            // Ships move closer for boarding
            tl.to(fleetAShips.filter(ship => !ship.classList.contains('sinking')), {
                x: "+=30",
                duration: 0.8,
                ease: "power2.inOut"
            })
            .to(fleetBShips.filter(ship => !ship.classList.contains('sinking')), {
                x: "-=30",
                duration: 0.8,
                ease: "power2.inOut"
            }, "<");
            
            // Create boarding plank effect with GSAP
            if (fleetAShips.length > 0 && fleetBShips.length > 0) {
                tl.call(() => {
                    const boardingEffect = document.createElement('div');
                    boardingEffect.className = 'boarding-effect';
                    boardingEffect.style.position = 'absolute';
                    boardingEffect.style.height = '4px';
                    boardingEffect.style.backgroundColor = '#8B4513';
                    boardingEffect.style.transformOrigin = 'left center';
                    boardingEffect.style.zIndex = '10';
                    
                    const arenaRect = document.getElementById('battleArena').getBoundingClientRect();
                    const shipARect = fleetAShips[0].getBoundingClientRect();
                    
                    boardingEffect.style.left = `${shipARect.left - arenaRect.left + shipARect.width}px`;
                    boardingEffect.style.top = `${shipARect.top - arenaRect.top + shipARect.height/2}px`;
                    
                    document.getElementById('combatEffects').appendChild(boardingEffect);
                    
                    // Animate plank extending
                    gsap.fromTo(boardingEffect, 
                        { width: 0, scaleX: 0 },
                        { 
                            width: '120px', 
                            scaleX: 1,
                            duration: 0.5,
                            ease: "power2.out",
                            onComplete: () => {
                                // Animate crew crossing
                                for (let i = 0; i < 3; i++) {
                                    setTimeout(() => {
                                        const crew = document.createElement('div');
                                        crew.style.position = 'absolute';
                                        crew.style.width = '8px';
                                        crew.style.height = '8px';
                                        crew.style.backgroundColor = '#4A5568';
                                        crew.style.borderRadius = '50%';
                                        crew.style.left = '0px';
                                        crew.style.top = '-2px';
                                        boardingEffect.appendChild(crew);
                                        
                                        gsap.to(crew, {
                                            x: '120px',
                                            duration: 0.8,
                                            ease: "none",
                                            onComplete: () => crew.remove()
                                        });
                                    }, i * 200);
                                }
                            }
                        }
                    );
                    
                    // Remove boarding effect after animation
                    setTimeout(() => {
                        gsap.to(boardingEffect, {
                            opacity: 0,
                            duration: 0.3,
                            onComplete: () => {
                                if (boardingEffect.parentNode) {
                                    boardingEffect.parentNode.removeChild(boardingEffect);
                                }
                            }
                        });
                    }, 2500);
                }, null, "+=0.5");
            }
            
            // Ships return to original positions
            tl.to(fleetAShips.filter(ship => !ship.classList.contains('sinking')), {
                x: "-=30",
                duration: 0.8,
                ease: "power2.inOut"
            }, "+=1.5")
            .to(fleetBShips.filter(ship => !ship.classList.contains('sinking')), {
                x: "+=30",
                duration: 0.8,
                ease: "power2.inOut"
            }, "<");
        }

        // Animate ship taking damage with GSAP
        function animateShipDamage(fleetClass, shipIndex) {
            const shipElement = document.getElementById(`${fleetClass}-ship-${shipIndex}`);
            if (!shipElement) return;
            
            // GSAP damage animation sequence
            const tl = gsap.timeline();
            
            // Impact shake and flash
            tl.to(shipElement, {
                x: "+=5",
                rotation: "+=3",
                duration: 0.1,
                ease: "power2.out"
            })
            .to(shipElement, {
                x: "-=10",
                rotation: "-=6",
                duration: 0.1,
                ease: "power2.out"
            })
            .to(shipElement, {
                x: "+=5",
                rotation: "+=3",
                duration: 0.1,
                ease: "power2.out"
            })
            .to(shipElement, {
                filter: "brightness(1.5) contrast(1.2)",
                duration: 0.1,
                yoyo: true,
                repeat: 2
            }, 0)
            .to(shipElement, {
                filter: "brightness(1) contrast(1)",
                duration: 0.2
            });
            
            // Add smoke effect
            tl.call(() => createSmokeEffect(shipElement), null, "+=0.1");
        }

        // Animate ship sinking with GSAP
        function animateShipSinking(fleetClass, shipIndex) {
            const shipElement = document.getElementById(`${fleetClass}-ship-${shipIndex}`);
            if (!shipElement) return;
            
            shipElement.classList.add('sinking');
            
            // GSAP sinking animation
            const tl = gsap.timeline();
            
            // Tilting and sinking motion
            tl.to(shipElement, {
                rotation: "+=15",
                y: "+=10",
                duration: 0.5,
                ease: "power2.in"
            })
            .to(shipElement, {
                rotation: "+=30",
                y: "+=50",
                scaleY: 0.7,
                duration: 1,
                ease: "power2.inOut"
            })
            .to(shipElement, {
                y: "+=100",
                scaleY: 0.3,
                opacity: 0.3,
                duration: 0.8,
                ease: "power2.in"
            })
            .to(shipElement, {
                visibility: "hidden",
                duration: 0,
                onComplete: () => {
                    // Create sinking bubbles effect
                    createSinkingBubbles(shipElement);
                }
            });
        }

        // Create explosion effect with GSAP
        function createExplosion(targetElement) {
            const explosion = document.createElement('div');
            explosion.className = 'explosion';
            explosion.style.position = 'absolute';
            explosion.style.width = '40px';
            explosion.style.height = '40px';
            explosion.style.borderRadius = '50%';
            explosion.style.background = 'radial-gradient(circle, #ff6b00 0%, #ff4500 50%, #ff0000 100%)';
            explosion.style.zIndex = '20';
            
            const targetRect = targetElement.getBoundingClientRect();
            const arenaRect = document.getElementById('battleArena').getBoundingClientRect();
            
            explosion.style.left = `${targetRect.left - arenaRect.left + targetRect.width/2 - 20}px`;
            explosion.style.top = `${targetRect.top - arenaRect.top + targetRect.height/2 - 20}px`;
            
            document.getElementById('combatEffects').appendChild(explosion);
            
            // GSAP explosion animation
            const tl = gsap.timeline();
            
            tl.fromTo(explosion, 
                { scale: 0, opacity: 1 },
                { 
                    scale: 2,
                    opacity: 0.8,
                    duration: 0.2,
                    ease: "power2.out"
                }
            )
            .to(explosion, {
                scale: 3,
                opacity: 0,
                duration: 0.4,
                ease: "power2.in",
                onComplete: () => {
                    if (explosion.parentNode) {
                        explosion.parentNode.removeChild(explosion);
                    }
                }
            });
            
            // Create debris particles
            for (let i = 0; i < 8; i++) {
                setTimeout(() => createDebrisParticle(targetElement), i * 50);
            }
            
            // Create smoke effect
            setTimeout(() => {
                createSmokeEffect(targetElement);
            }, 200);
        }

        // Create muzzle flash effect with GSAP
        function createMuzzleFlash(shipElement) {
            const flash = document.createElement('div');
            flash.style.position = 'absolute';
            flash.style.width = '30px';
            flash.style.height = '8px';
            flash.style.background = 'linear-gradient(90deg, #ffff00, #ff6600, #ff0000)';
            flash.style.borderRadius = '50px';
            flash.style.zIndex = '15';
            
            const shipRect = shipElement.getBoundingClientRect();
            const arenaRect = document.getElementById('battleArena').getBoundingClientRect();
            
            // Position flash at cannon side
            const isFleetA = shipElement.classList.contains('fleet-a');
            flash.style.left = `${shipRect.left - arenaRect.left + (isFleetA ? shipRect.width : -30)}px`;
            flash.style.top = `${shipRect.top - arenaRect.top + shipRect.height/2 - 4}px`;
            
            document.getElementById('combatEffects').appendChild(flash);
            
            // GSAP muzzle flash animation
            gsap.fromTo(flash,
                { scaleX: 0, opacity: 1 },
                {
                    scaleX: 1,
                    opacity: 0,
                    duration: 0.3,
                    ease: "power2.out",
                    onComplete: () => {
                        if (flash.parentNode) {
                            flash.parentNode.removeChild(flash);
                        }
                    }
                }
            );
        }

        // Create debris particle effect with GSAP
        function createDebrisParticle(targetElement) {
            const debris = document.createElement('div');
            debris.style.position = 'absolute';
            debris.style.width = '4px';
            debris.style.height = '4px';
            debris.style.backgroundColor = '#8B4513';
            debris.style.borderRadius = '50%';
            debris.style.zIndex = '10';
            
            const targetRect = targetElement.getBoundingClientRect();
            const arenaRect = document.getElementById('battleArena').getBoundingClientRect();
            
            debris.style.left = `${targetRect.left - arenaRect.left + targetRect.width/2}px`;
            debris.style.top = `${targetRect.top - arenaRect.top + targetRect.height/2}px`;
            
            document.getElementById('combatEffects').appendChild(debris);
            
            // Random trajectory
            const angle = Math.random() * Math.PI * 2;
            const distance = 30 + Math.random() * 40;
            const endX = Math.cos(angle) * distance;
            const endY = Math.sin(angle) * distance;
            
            // GSAP debris animation
            gsap.to(debris, {
                x: endX,
                y: endY,
                rotation: 360,
                opacity: 0,
                duration: 0.8,
                ease: "power2.out",
                onComplete: () => {
                    if (debris.parentNode) {
                        debris.parentNode.removeChild(debris);
                    }
                }
            });
        }

        // Create water splash effect with GSAP
        function createWaterSplash(shipElement) {
            const splash = document.createElement('div');
            splash.style.position = 'absolute';
            splash.style.width = '20px';
            splash.style.height = '20px';
            splash.style.background = 'radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(135,206,250,0.6) 50%, transparent 100%)';
            splash.style.borderRadius = '50%';
            splash.style.zIndex = '5';
            
            const shipRect = shipElement.getBoundingClientRect();
            const arenaRect = document.getElementById('battleArena').getBoundingClientRect();
            
            splash.style.left = `${shipRect.left - arenaRect.left + Math.random() * shipRect.width}px`;
            splash.style.top = `${shipRect.top - arenaRect.top + shipRect.height + 10}px`;
            
            document.getElementById('combatEffects').appendChild(splash);
            
            // GSAP splash animation
            const tl = gsap.timeline();
            
            tl.fromTo(splash,
                { scale: 0, y: 0 },
                { 
                    scale: 1.5,
                    y: -15,
                    duration: 0.3,
                    ease: "power2.out"
                }
            )
            .to(splash, {
                scale: 0.5,
                y: 0,
                opacity: 0,
                duration: 0.4,
                ease: "power2.in",
                onComplete: () => {
                    if (splash.parentNode) {
                        splash.parentNode.removeChild(splash);
                    }
                }
            });
        }

        // Create sinking bubbles effect with GSAP
        function createSinkingBubbles(shipElement) {
            for (let i = 0; i < 12; i++) {
                setTimeout(() => {
                    const bubble = document.createElement('div');
                    bubble.style.position = 'absolute';
                    bubble.style.width = `${4 + Math.random() * 8}px`;
                    bubble.style.height = bubble.style.width;
                    bubble.style.backgroundColor = 'rgba(135, 206, 250, 0.7)';
                    bubble.style.borderRadius = '50%';
                    bubble.style.zIndex = '8';
                    
                    const shipRect = shipElement.getBoundingClientRect();
                    const arenaRect = document.getElementById('battleArena').getBoundingClientRect();
                    
                    bubble.style.left = `${shipRect.left - arenaRect.left + Math.random() * shipRect.width}px`;
                    bubble.style.top = `${shipRect.top - arenaRect.top + shipRect.height}px`;
                    
                    document.getElementById('combatEffects').appendChild(bubble);
                    
                    // GSAP bubble animation
                    gsap.to(bubble, {
                        y: -60 - Math.random() * 40,
                        x: (Math.random() - 0.5) * 20,
                        scale: 0,
                        opacity: 0,
                        duration: 1.5 + Math.random(),
                        ease: "power1.out",
                        onComplete: () => {
                            if (bubble.parentNode) {
                                bubble.parentNode.removeChild(bubble);
                            }
                        }
                    });
                }, i * 100);
            }
        }

        // Create smoke effect with GSAP
        function createSmokeEffect(targetElement) {
            const smoke = document.createElement('div');
            smoke.style.position = 'absolute';
            smoke.style.width = '30px';
            smoke.style.height = '30px';
            smoke.style.background = 'radial-gradient(circle, rgba(64,64,64,0.8) 0%, rgba(128,128,128,0.4) 50%, transparent 100%)';
            smoke.style.borderRadius = '50%';
            smoke.style.zIndex = '12';
            
            const targetRect = targetElement.getBoundingClientRect();
            const arenaRect = document.getElementById('battleArena').getBoundingClientRect();
            
            smoke.style.left = `${targetRect.left - arenaRect.left + targetRect.width/2 - 15}px`;
            smoke.style.top = `${targetRect.top - arenaRect.top + targetRect.height/2 - 15}px`;
            
            document.getElementById('combatEffects').appendChild(smoke);
            
            // GSAP smoke animation
            const tl = gsap.timeline();
            
            tl.fromTo(smoke,
                { scale: 0.5, opacity: 0.8 },
                {
                    scale: 2,
                    y: -40,
                    opacity: 0,
                    duration: 1.5,
                    ease: "power1.out",
                    onComplete: () => {
                        if (smoke.parentNode) {
                            smoke.parentNode.removeChild(smoke);
                        }
                    }
                }
            );
        }
            
            smoke.style.left = `${targetRect.left - arenaRect.left + targetRect.width/2 - 10}px`;
        // Update phase display with GSAP animation
        function updatePhaseDisplay(phase) {
            const phaseDisplay = document.getElementById('phaseDisplay');
            if (phaseDisplay) {
                // GSAP phase transition animation
                gsap.to(phaseDisplay, {
                    scale: 1.2,
                    duration: 0.2,
                    ease: "power2.out",
                    onComplete: () => {
                        phaseDisplay.textContent = `Phase: ${phase}`;
                        gsap.to(phaseDisplay, {
                            scale: 1,
                            duration: 0.3,
                            ease: "bounce.out"
                        });
                    }
                });
            }
        }

        // Update range display with GSAP animation
        function updateRangeDisplay(range) {
            const rangeDisplay = document.getElementById('rangeDisplay');
            if (rangeDisplay) {
                // GSAP range change animation
                gsap.to(rangeDisplay, {
                    scale: 1.1,
                    color: "#ff6b00",
                    duration: 0.2,
                    ease: "power2.out",
                    onComplete: () => {
                        rangeDisplay.textContent = `Range: ${range}`;
                        gsap.to(rangeDisplay, {
                            scale: 1,
                            color: "#ffffff",
                            duration: 0.3,
                            ease: "power2.out"
                        });
                    }
                });
            }
        }

        // Show victory animation with GSAP
        function showVictoryAnimation(winner) {
            const victoryEffect = document.createElement('div');
            victoryEffect.style.position = 'absolute';
            victoryEffect.style.left = '50%';
            victoryEffect.style.top = '50%';
            victoryEffect.style.transform = 'translate(-50%, -50%)';
            victoryEffect.style.textAlign = 'center';
            victoryEffect.style.color = '#FFD700';
            victoryEffect.style.fontWeight = 'bold';
            victoryEffect.style.fontSize = '32px';
            victoryEffect.style.textShadow = '2px 2px 4px rgba(0,0,0,0.5)';
            victoryEffect.style.zIndex = '100';
            victoryEffect.innerHTML = `
                <div>🏆 VICTORY! 🏆</div>
                <div style="font-size: 18px; margin-top: 10px;">${winner} Wins!</div>
            `;
            
            document.getElementById('combatEffects').appendChild(victoryEffect);
            
            // GSAP victory animation sequence
            const tl = gsap.timeline();
            
            tl.fromTo(victoryEffect,
                { scale: 0, rotation: -180, opacity: 0 },
                { 
                    scale: 1,
                    rotation: 0,
                    opacity: 1,
                    duration: 0.8,
                    ease: "back.out(1.7)"
                }
            )
            .to(victoryEffect, {
                scale: 1.1,
                duration: 0.5,
                ease: "power2.inOut",
                yoyo: true,
                repeat: 3
            })
            .to(victoryEffect, {
                scale: 0,
                opacity: 0,
                duration: 0.5,
                ease: "power2.in",
                onComplete: () => {
                    if (victoryEffect.parentNode) {
                        victoryEffect.parentNode.removeChild(victoryEffect);
                    }
                }
            }, "+=2");
        }

        // Main naval battle simulation with delays and animations
        async function simulateNavalBattle() {
            if (window.fleetA.length === 0 || window.fleetB.length === 0) {
                updateNavalBattleDisplay('<div class="text-red-600 font-bold">⚠️ Both fleets must have at least one ship!</div>');
                return;
            }
            
            // Disable battle button during simulation
            const battleButton = document.getElementById('simulateNavalBattle');
            battleButton.disabled = true;
            battleButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Simulating Battle...';
            
            // Initialize battle
            currentBattle = {
                range: 2,
                gunneryPhase: 0,
                maxGunneryPhases: 10,
                fleetAShips: [...window.fleetA.map(ship => ({...ship}))],
                fleetBShips: [...window.fleetB.map(ship => ({...ship}))],
                battleLog: []
            };
            
            // Initialize 2D battle arena
            initializeBattleArena();
            
            const fleetAName = document.getElementById('fleetAName').value || 'Fleet A';
            const fleetBName = document.getElementById('fleetBName').value || 'Fleet B';
            
            let battleHTML = `
                <div class="text-center mb-6 phase-reveal">
                    <h3 class="text-2xl font-bold text-blue-600">⚔️ Naval Battle: ${fleetAName} vs ${fleetBName} ⚔️</h3>
                    <div class="range-indicator">Starting Range: ${currentBattle.range}</div>
                    <div class="phase-counter">Battle Commencing...</div>
                </div>
                
                <!-- 2D Battle Arena -->
                <div class="battle-arena" id="battleArena">
                    <div class="sea-waves"></div>
                    <div class="range-indicator-visual" id="rangeDisplay">Range: ${currentBattle.range}</div>
                    <div class="ship ship-a" id="shipA"></div>
                    <div class="ship ship-b" id="shipB"></div>
                </div>
            `;
            
            updateNavalBattleDisplay(battleHTML);
            await delay(2000); // Initial delay
            
            // Simulate battle phases
            let battleEnded = false;
            let currentShipA = 0;
            let currentShipB = 0;
            let phaseCount = 0;
            
            while (!battleEnded && currentBattle.gunneryPhase < currentBattle.maxGunneryPhases) {
                phaseCount++;
                const shipA = currentBattle.fleetAShips[currentShipA % currentBattle.fleetAShips.length];
                const shipB = currentBattle.fleetBShips[currentShipB % currentBattle.fleetBShips.length];
                
                // Skip sunk/captured ships
                if (shipA.status !== 'Active') {
                    currentShipA++;
                    continue;
                }
                if (shipB.status !== 'Active') {
                    currentShipB++;
                    continue;
                }
                
                // Show loading indicator
                const loadingHTML = `
                    <div class="battle-loading">
                        <div class="loading-spinner"></div>
                        <span>Preparing Combat Phase ${phaseCount}...</span>
                    </div>
                `;
                updateNavalBattleDisplay(loadingHTML, true);
                await delay(1500);
                
                let phaseHTML = `<div class="combat-phase phase-reveal">`;
                phaseHTML += `<div class="phase-counter">Combat Phase ${phaseCount}</div>`;
                
                // Maneuver Phase
                const maneuver = maneuverPhase(shipA, shipB);
                
                // Animate maneuver
                animateManeuver(maneuver.winner, maneuver.action, shipA, shipB);
                updateRangeDisplay(currentBattle.range);
                
                phaseHTML += `
                    <h4 class="font-bold text-blue-600 mb-2">⚓ Maneuver Phase</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="p-3 bg-purple-50 rounded-lg">
                            <strong>🏴‍☠️ ${fleetAName} Ship ${shipA.id}</strong><br>
                            <span class="text-lg">🎲 Rolled: ${maneuver.shipAAutoFail ? '0 (Hull Breach - Auto-fail)' : maneuver.rollA}</span>
                        </div>
                        <div class="p-3 bg-red-50 rounded-lg">
                            <strong>⚓ ${fleetBName} Ship ${shipB.id}</strong><br>
                            <span class="text-lg">🎲 Rolled: ${maneuver.shipBAutoFail ? '0 (Hull Breach - Auto-fail)' : maneuver.rollB}</span>
                        </div>
                    </div>
                    <div class="text-center p-3 bg-blue-50 rounded-lg mb-4">
                        <strong>📋 Result:</strong> ${maneuver.winner === 'A' ? fleetAName : maneuver.winner === 'B' ? fleetBName : 'Tie'} 
                        ${maneuver.winner !== 'tie' ? `<span class="text-green-600 font-bold">${maneuver.action}s</span>` : '<span class="text-gray-600">both hold position</span>'}
                    </div>
                    <div class="range-indicator range-change">Current Range: ${currentBattle.range}</div>
                `;
                
                updateNavalBattleDisplay(phaseHTML, true);
                await delay(3000); // 3 second delay after maneuver phase
                
                // Check for boarding at Range 0
                if (currentBattle.range === 0) {
                    const boarding = boardingPhase(shipA, shipB);
                    
                    // Animate boarding
                    animateBoarding();
                    
                    let boardingHTML = `
                        <div class="mt-4 p-4 bg-red-100 border-l-4 border-red-500 rounded">
                            <h4 class="font-bold text-red-600 mb-2">🏴‍☠️ BOARDING PHASE</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div class="p-3 bg-purple-50 rounded-lg">
                                    <strong>${fleetAName} Ship ${shipA.id}</strong><br>
                                    <span class="text-lg">⚔️ Rolled: ${boarding.rollA}</span>
                                </div>
                                <div class="p-3 bg-red-50 rounded-lg">
                                    <strong>${fleetBName} Ship ${shipB.id}</strong><br>
                                    <span class="text-lg">⚔️ Rolled: ${boarding.rollB}</span>
                                </div>
                            </div>
                    `;
                    
                    if (boarding.winner) {
                        const winnerFleet = boarding.winner === 'A' ? fleetAName : fleetBName;
                        const loserFleet = boarding.winner === 'A' ? fleetBName : fleetAName;
                        boardingHTML += `<div class="text-center p-3 bg-green-100 rounded-lg"><p class="font-bold text-green-600 text-lg">🎉 ${winnerFleet} captures ${loserFleet} ship!</p></div>`;
                        battleEnded = true;
                    } else {
                        boardingHTML += `<div class="text-center p-3 bg-yellow-100 rounded-lg"><p class="text-yellow-700">Boarding attempt fails, returning to maneuver phase</p></div>`;
                        currentBattle.range = 1; // Move back to Range 1
                        updateRangeDisplay(currentBattle.range);
                    }
                    
                    boardingHTML += `</div>`;
                    updateNavalBattleDisplay(boardingHTML, true);
                    await delay(3000);
                }
                
                // Gunnery Phase (if not boarding)
                if (currentBattle.range > 0 && !battleEnded) {
                    currentBattle.gunneryPhase++;
                    
                    let gunneryHTML = `
                        <div class="mt-4 p-4 bg-orange-100 border-l-4 border-orange-500 rounded">
                            <div class="gunnery-phase-counter">💥 Gunnery Phase ${currentBattle.gunneryPhase}/10</div>
                            <h4 class="font-bold text-orange-600 mb-2">Cannon Fire Exchange</h4>
                    `;
                    
                    updateNavalBattleDisplay(gunneryHTML, true);
                    await delay(1500);
                    
                    const gunnery = gunneryPhase(shipA, shipB);
                    
                    // Animate gunnery with enhanced effects
                    animateGunnery(gunnery.hitA, gunnery.hitB, shipA, shipB);
                    
                    let gunneryResultHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div class="p-3 bg-purple-50 rounded-lg ${gunnery.hitA ? 'hit-animation' : ''}">
                                <strong>🏴‍☠️ ${fleetAName} Ship ${shipA.id}</strong><br>
                                <span class="text-sm text-gray-600">Base roll + ${gunnery.modifierA} modifier</span><br>
                                <span class="text-lg">🎲 Total: ${gunnery.rollA} - ${gunnery.hitA ? '<span class="text-red-600 font-bold">💥 HIT!</span>' : '<span class="text-gray-500">Miss</span>'}</span>
                            </div>
                            <div class="p-3 bg-red-50 rounded-lg ${gunnery.hitB ? 'hit-animation' : ''}">
                                <strong>⚓ ${fleetBName} Ship ${shipB.id}</strong><br>
                                <span class="text-sm text-gray-600">Base roll + ${gunnery.modifierB} modifier</span><br>
                                <span class="text-lg">🎲 Total: ${gunnery.rollB} - ${gunnery.hitB ? '<span class="text-red-600 font-bold">💥 HIT!</span>' : '<span class="text-gray-500">Miss</span>'}</span>
                            </div>
                        </div>
                    `;
                    
                    updateNavalBattleDisplay(gunneryResultHTML, true);
                    await delay(2000);
                    
                    // Damage reports
                    if (gunnery.damageA || gunnery.damageB) {
                        let damageHTML = `<div class="mt-4">`;
                        
                        if (gunnery.damageA) {
                            damageHTML += `
                                <div class="damage-report damage-impact mb-3">
                                    <strong>💀 ${fleetAName} Ship ${shipA.id} Damage Report:</strong><br>
                                    <span class="text-lg font-bold text-red-600">${gunnery.damageA.name}</span><br>
                                    <span class="text-sm italic">${gunnery.damageA.effect}</span>
                                </div>
                            `;
                            if (shipA.status === 'Sunk') {
                                damageHTML += `<div class="text-center p-3 bg-red-100 rounded-lg ship-sink-animation"><p class="font-bold text-red-600 text-lg">🔥⚰️ ${fleetAName} Ship ${shipA.id} has been sunk!</p></div>`;
                            }
                        }
                        
                        if (gunnery.damageB) {
                            damageHTML += `
                                <div class="damage-report damage-impact mb-3">
                                    <strong>💀 ${fleetBName} Ship ${shipB.id} Damage Report:</strong><br>
                                    <span class="text-lg font-bold text-red-600">${gunnery.damageB.name}</span><br>
                                    <span class="text-sm italic">${gunnery.damageB.effect}</span>
                                </div>
                            `;
                            if (shipB.status === 'Sunk') {
                                damageHTML += `<div class="text-center p-3 bg-red-100 rounded-lg ship-sink-animation"><p class="font-bold text-red-600 text-lg">🔥⚰️ ${fleetBName} Ship ${shipB.id} has been sunk!</p></div>`;
                            }
                        }
                        
                        damageHTML += `</div></div>`;
                        updateNavalBattleDisplay(damageHTML, true);
                        await delay(3000);
                    } else {
                        updateNavalBattleDisplay(`</div>`, true);
                        await delay(1500);
                    }
                }
                
                updateNavalBattleDisplay(`</div>`, true);
                
                // Check for battle end conditions
                const activeShipsA = currentBattle.fleetAShips.filter(s => s.status === 'Active').length;
                const activeShipsB = currentBattle.fleetBShips.filter(s => s.status === 'Active').length;
                
                if (activeShipsA === 0 || activeShipsB === 0 || currentBattle.range >= 4) {
                    battleEnded = true;
                }
                
                // Move to next ships if current ones are out of action
                if (shipA.status !== 'Active') currentShipA++;
                if (shipB.status !== 'Active') currentShipB++;
            }
            
            // Battle conclusion with animation
            await delay(2000);
            let conclusionHTML = `<div class="text-center mt-6 p-6 victory-announcement rounded-lg">`;
            
            if (currentBattle.gunneryPhase >= currentBattle.maxGunneryPhases) {
                // 10 gunnery phase limit reached
                const damageA = currentBattle.fleetAShips.reduce((acc, ship) => 
                    acc + ship.damageReports.filter(d => d.roll <= 4).length, 0);
                const damageB = currentBattle.fleetBShips.reduce((acc, ship) => 
                    acc + ship.damageReports.filter(d => d.roll <= 4).length, 0);
                
                if (damageA > damageB) {
                    conclusionHTML += `<h3 class="text-3xl font-bold mb-4">🏆 ${fleetBName} Wins!</h3>`;
                    conclusionHTML += `<p class="text-lg">⏰ 10 gunnery phase limit reached. ${fleetAName} took more severe damage (${damageA} vs ${damageB})</p>`;
                    showVictoryAnimation(fleetBName);
                } else if (damageB > damageA) {
                    conclusionHTML += `<h3 class="text-3xl font-bold mb-4">🏆 ${fleetAName} Wins!</h3>`;
                    conclusionHTML += `<p class="text-lg">⏰ 10 gunnery phase limit reached. ${fleetBName} took more severe damage (${damageB} vs ${damageA})</p>`;
                    showVictoryAnimation(fleetAName);
                } else {
                    conclusionHTML += `<h3 class="text-3xl font-bold mb-4">⚖️ Draw!</h3>`;
                    conclusionHTML += `<p class="text-lg">⏰ 10 gunnery phase limit reached. Both fleets took equal damage (${damageA} each)</p>`;
                }
            } else {
                const activeShipsA = currentBattle.fleetAShips.filter(s => s.status === 'Active').length;
                const activeShipsB = currentBattle.fleetBShips.filter(s => s.status === 'Active').length;
                
                if (activeShipsA === 0 && activeShipsB === 0) {
                    conclusionHTML += `<h3 class="text-3xl font-bold mb-4">💥 Mutual Destruction!</h3>`;
                    conclusionHTML += `<p class="text-lg">Both fleets have been completely destroyed</p>`;
                } else if (activeShipsA === 0) {
                    conclusionHTML += `<h3 class="text-3xl font-bold mb-4">🏆 ${fleetBName} Wins!</h3>`;
                    conclusionHTML += `<p class="text-lg">All ${fleetAName} ships destroyed or captured</p>`;
                    showVictoryAnimation(fleetBName);
                } else if (activeShipsB === 0) {
                    conclusionHTML += `<h3 class="text-3xl font-bold mb-4">🏆 ${fleetAName} Wins!</h3>`;
                    conclusionHTML += `<p class="text-lg">All ${fleetBName} ships destroyed or captured</p>`;
                    showVictoryAnimation(fleetAName);
                } else if (currentBattle.range >= 4) {
                    conclusionHTML += `<h3 class="text-3xl font-bold mb-4">🏃‍♂️ Tactical Retreat!</h3>`;
                    conclusionHTML += `<p class="text-lg">One fleet successfully retreated from combat</p>`;
                }
            }
            
            conclusionHTML += `
                <div class="mt-4 p-4 bg-white bg-opacity-20 rounded-lg">
                    <p class="text-sm">Battle Duration: ${phaseCount} combat phases</p>
                    <p class="text-sm">Gunnery Phases: ${currentBattle.gunneryPhase}/10</p>
                    <p class="text-sm">Final Range: ${currentBattle.range}</p>
                </div>
            </div>`;
            
            updateNavalBattleDisplay(conclusionHTML, true);
            
            // Re-enable battle button
            battleButton.disabled = false;
            battleButton.innerHTML = '<i class="fas fa-anchor mr-2"></i>Simulate Naval Battle';
        }
        
        // Helper function for delays
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // Animation helper functions
        function updateRangeDisplay(range) {
            const rangeDisplay = document.getElementById('rangeDisplay');
            if (rangeDisplay) {
                rangeDisplay.textContent = `Range: ${range}`;
                rangeDisplay.classList.add('range-change');
                setTimeout(() => rangeDisplay.classList.remove('range-change'), 500);
            }
        }
        
        function animateManeuver(winner, action, shipA, shipB) {
            const shipAElement = document.getElementById('shipA');
            const shipBElement = document.getElementById('shipB');
            
            if (!shipAElement || !shipBElement) return;
            
            // Remove any existing animation classes
            shipAElement.className = 'ship ship-a';
            shipBElement.className = 'ship ship-b';
            
            // Add animation based on winner and action
            if (winner === 'A') {
                shipAElement.classList.add(`ship-maneuver-${action}`);
            } else if (winner === 'B') {
                shipBElement.classList.add(`ship-maneuver-${action}`);
            } else {
                // Tie - both ships hold
                shipAElement.classList.add('ship-maneuver-hold');
                shipBElement.classList.add('ship-maneuver-hold');
            }
            
            // Update ship positions based on range
            setTimeout(() => {
                updateShipPositions();
            }, 750);
        }
        
        function updateShipPositions() {
            const shipAElement = document.getElementById('shipA');
            const shipBElement = document.getElementById('shipB');
            const range = currentBattle.range;
            
            if (!shipAElement || !shipBElement) return;
            
            // Adjust ship positions based on range
            const baseDistanceA = 50;
            const baseDistanceB = 50;
            const rangeMultiplier = 40;
            
            shipAElement.style.left = `${baseDistanceA + (range * rangeMultiplier)}px`;
            shipBElement.style.right = `${baseDistanceB + (range * rangeMultiplier)}px`;
        }
        
        function animateGunnery(hitA, hitB, damageA, damageB) {
            const arena = document.getElementById('battleArena');
            const shipA = document.getElementById('shipA');
            const shipB = document.getElementById('shipB');
            
            if (!arena || !shipA || !shipB) return;
            
            // Create cannon fire effects
            if (hitA || Math.random() > 0.3) { // Show cannon fire even on misses sometimes
                const cannonFireA = document.createElement('div');
                cannonFireA.className = 'cannon-fire cannon-fire-a';
                cannonFireA.style.top = '115px';
                arena.appendChild(cannonFireA);
                
                setTimeout(() => arena.removeChild(cannonFireA), 1000);
            }
            
            if (hitB || Math.random() > 0.3) {
                const cannonFireB = document.createElement('div');
                cannonFireB.className = 'cannon-fire cannon-fire-b';
                cannonFireB.style.top = '185px';
                arena.appendChild(cannonFireB);
                
                setTimeout(() => arena.removeChild(cannonFireB), 1000);
            }
            
            // Add hit effects and damage animations
            setTimeout(() => {
                if (hitA && damageB) {
                    shipB.classList.add('ship-hit');
                    createExplosion(shipB);
                    
                    if (damageB.name === 'Kill Shot') {
                        setTimeout(() => {
                            shipB.classList.add('ship-sinking');
                        }, 800);
                    }
                }
                
                if (hitB && damageA) {
                    shipA.classList.add('ship-hit');
                    createExplosion(shipA);
                    
                    if (damageA.name === 'Kill Shot') {
                        setTimeout(() => {
                            shipA.classList.add('ship-sinking');
                        }, 800);
                    }
                }
                
                // Remove hit animation classes
                setTimeout(() => {
                    shipA.classList.remove('ship-hit');
                    shipB.classList.remove('ship-hit');
                }, 800);
            }, 500);
        }
        
        function createExplosion(targetShip) {
            const arena = document.getElementById('battleArena');
            if (!arena || !targetShip) return;
            
            const explosion = document.createElement('div');
            explosion.className = 'hit-explosion';
            
            const rect = targetShip.getBoundingClientRect();
            const arenaRect = arena.getBoundingClientRect();
            
            explosion.style.left = `${rect.left - arenaRect.left + 10}px`;
            explosion.style.top = `${rect.top - arenaRect.top + 5}px`;
            
            arena.appendChild(explosion);
            
            setTimeout(() => {
                if (arena.contains(explosion)) {
                    arena.removeChild(explosion);
                }
            }, 600);
        }
        
        function animateBoarding() {
            const arena = document.getElementById('battleArena');
            if (!arena) return;
            
            const boardingEffect = document.createElement('div');
            boardingEffect.className = 'boarding-animation';
            boardingEffect.textContent = '⚔️🏴‍☠️';
            
            arena.appendChild(boardingEffect);
            
            setTimeout(() => {
                if (arena.contains(boardingEffect)) {
                    arena.removeChild(boardingEffect);
                }
            }, 2000);
        }
        
        function addCannonSmoke(ship) {
            const arena = document.getElementById('battleArena');
            if (!arena || !ship) return;
            
            const smoke = document.createElement('div');
            smoke.className = 'cannon-smoke';
            
            const rect = ship.getBoundingClientRect();
            const arenaRect = arena.getBoundingClientRect();
            
            smoke.style.left = `${rect.left - arenaRect.left + 60}px`;
            smoke.style.top = `${rect.top - arenaRect.top + 10}px`;
            smoke.style.opacity = '0.8';
            
            arena.appendChild(smoke);
            
            // Animate smoke dissipation
            let opacity = 0.8;
            const fadeInterval = setInterval(() => {
                opacity -= 0.1;
                smoke.style.opacity = opacity;
                if (opacity <= 0) {
                    clearInterval(fadeInterval);
                    if (arena.contains(smoke)) {
                        arena.removeChild(smoke);
                    }
                }
            }, 100);
        }

        // Update battle display
        function updateNavalBattleDisplay(content, append = false) {
            const resultDiv = document.getElementById('navalBattleResult');
            if (append) {
                resultDiv.innerHTML += content;
            } else {
                resultDiv.innerHTML = content;
            }
            resultDiv.scrollTop = resultDiv.scrollHeight;
        }

        // Clear battle
        function newNavalBattle() {
            currentBattle = { range: 2, gunneryPhase: 0, maxGunneryPhases: 10, battleLog: [] };
            
            // Hide battle arena
            const battleArena = document.getElementById('battleArena');
            if (battleArena) {
                battleArena.style.display = 'none';
            }
            
            const resultDiv = document.getElementById('navalBattleResult');
            resultDiv.innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <i class="fas fa-ship text-4xl mb-4"></i>
                    <p>Set up your fleets and click "Simulate Naval Battle" to begin the engagement!</p>
                    <p class="text-sm mt-2">⚠️ Remember: Combat is limited to 10 Gunnery phases maximum</p>
                </div>
            `;
        }

        // Generate battle report
        function generateNavalReport() {
            if (!currentBattle.fleetAShips || currentBattle.fleetAShips.length === 0) {
                alert('No battle data available. Please simulate a battle first.');
                return;
            }
            
            const fleetAName = document.getElementById('fleetAName').value || 'Fleet A';
            const fleetBName = document.getElementById('fleetBName').value || 'Fleet B';
            
            let report = `NAVAL BATTLE REPORT\n`;
            report += `===================\n\n`;
            report += `${fleetAName} vs ${fleetBName}\n`;
            report += `Gunnery Phases: ${currentBattle.gunneryPhase}/10\n`;
            report += `Final Range: ${currentBattle.range}\n\n`;
            
            report += `${fleetAName} Fleet Status:\n`;
            currentBattle.fleetAShips.forEach((ship, i) => {
                report += `  Ship ${ship.id}: ${ship.status} (${ship.damageReports.length} damage reports)\n`;
            });
            
            report += `\n${fleetBName} Fleet Status:\n`;
            currentBattle.fleetBShips.forEach((ship, i) => {
                report += `  Ship ${ship.id}: ${ship.status} (${ship.damageReports.length} damage reports)\n`;
            });
            
            // Download report
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `naval-battle-report-${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Moderator Control Functions
        function applyExternalModifiers() {
            // Get values from inputs
            window.externalModifiers.fleetA = {
                maneuver: parseInt(document.getElementById('modFleetAManeuver').value) || 0,
                gunnery: parseInt(document.getElementById('modFleetAGunnery').value) || 0,
                boarding: parseInt(document.getElementById('modFleetABoarding').value) || 0,
                damage: parseInt(document.getElementById('modFleetADamage').value) || 0,
                reason: document.getElementById('modFleetAReason').value || ''
            };
            
            window.externalModifiers.fleetB = {
                maneuver: parseInt(document.getElementById('modFleetBManeuver').value) || 0,
                gunnery: parseInt(document.getElementById('modFleetBGunnery').value) || 0,
                boarding: parseInt(document.getElementById('modFleetBBoarding').value) || 0,
                damage: parseInt(document.getElementById('modFleetBDamage').value) || 0,
                reason: document.getElementById('modFleetBReason').value || ''
            };
            
            updateModifierStatus();
            showMessage('External modifiers applied successfully!', 'success');
        }
        
        function clearExternalModifiers() {
            // Reset all modifier inputs
            document.getElementById('modFleetAManeuver').value = 0;
            document.getElementById('modFleetAGunnery').value = 0;
            document.getElementById('modFleetABoarding').value = 0;
            document.getElementById('modFleetADamage').value = 0;
            document.getElementById('modFleetAReason').value = '';
            
            document.getElementById('modFleetBManeuver').value = 0;
            document.getElementById('modFleetBGunnery').value = 0;
            document.getElementById('modFleetBBoarding').value = 0;
            document.getElementById('modFleetBDamage').value = 0;
            document.getElementById('modFleetBReason').value = '';
            
            // Reset external modifiers
            window.externalModifiers = {
                fleetA: { maneuver: 0, gunnery: 0, boarding: 0, damage: 0, reason: '' },
                fleetB: { maneuver: 0, gunnery: 0, boarding: 0, damage: 0, reason: '' }
            };
            
            updateModifierStatus();
            showMessage('All external modifiers cleared!', 'info');
        }
        
        function generateRandomEvent() {
            const events = [
                { 
                    name: 'Favorable Winds', 
                    fleetA: { maneuver: 2, gunnery: 1 }, 
                    fleetB: { maneuver: -1 },
                    description: 'The wind shifts in favor of Fleet A'
                },
                { 
                    name: 'Sudden Storm', 
                    fleetA: { maneuver: -2, gunnery: -1 }, 
                    fleetB: { maneuver: -2, gunnery: -1 },
                    description: 'A sudden storm affects both fleets equally'
                },
                { 
                    name: 'Divine Intervention', 
                    fleetA: { gunnery: 3, boarding: 2 }, 
                    fleetB: {},
                    description: 'The gods smile upon Fleet A'
                },
                { 
                    name: 'Cursed Waters', 
                    fleetA: { damage: -2 }, 
                    fleetB: { damage: -2 },
                    description: 'These waters are cursed - damage reports worsen'
                },
                { 
                    name: 'Superior Tactics', 
                    fleetA: {}, 
                    fleetB: { maneuver: 2, boarding: 1 },
                    description: 'Fleet B employs superior tactical maneuvers'
                },
                { 
                    name: 'Fog of War', 
                    fleetA: { gunnery: -2 }, 
                    fleetB: { gunnery: -2 },
                    description: 'Dense fog reduces gunnery accuracy for both fleets'
                }
            ];
            
            const randomEvent = events[Math.floor(Math.random() * events.length)];
            
            // Apply the random event modifiers
            Object.keys(randomEvent.fleetA).forEach(key => {
                if (key !== 'name' && key !== 'description') {
                    const input = document.getElementById(`modFleetA${key.charAt(0).toUpperCase() + key.slice(1)}`);
                    if (input) input.value = randomEvent.fleetA[key];
                }
            });
            
            Object.keys(randomEvent.fleetB).forEach(key => {
                if (key !== 'name' && key !== 'description') {
                    const input = document.getElementById(`modFleetB${key.charAt(0).toUpperCase() + key.slice(1)}`);
                    if (input) input.value = randomEvent.fleetB[key];
                }
            });
            
            // Set reason
            document.getElementById('modFleetAReason').value = randomEvent.name;
            document.getElementById('modFleetBReason').value = randomEvent.name;
            
            // Apply the modifiers
            applyExternalModifiers();
            
            showMessage(`Random Event: ${randomEvent.name} - ${randomEvent.description}`, 'warning');
        }
        
        function updateModifierStatus() {
            const statusDiv = document.getElementById('modifierStatus');
            const fleetAMods = window.externalModifiers.fleetA;
            const fleetBMods = window.externalModifiers.fleetB;
            
            const hasFleetAMods = Object.values(fleetAMods).some(val => val !== 0 && val !== '');
            const hasFleetBMods = Object.values(fleetBMods).some(val => val !== 0 && val !== '');
            
            if (!hasFleetAMods && !hasFleetBMods) {
                statusDiv.innerHTML = 'No external modifiers currently applied';
                statusDiv.className = 'mt-4 text-sm text-gray-600';
            } else {
                let status = '<div class="text-sm"><strong>Active Modifiers:</strong></div>';
                
                if (hasFleetAMods) {
                    status += '<div class="text-purple-700 font-medium">Fleet A: ';
                    const mods = [];
                    if (fleetAMods.maneuver !== 0) mods.push(`Maneuver ${fleetAMods.maneuver > 0 ? '+' : ''}${fleetAMods.maneuver}`);
                    if (fleetAMods.gunnery !== 0) mods.push(`Gunnery ${fleetAMods.gunnery > 0 ? '+' : ''}${fleetAMods.gunnery}`);
                    if (fleetAMods.boarding !== 0) mods.push(`Boarding ${fleetAMods.boarding > 0 ? '+' : ''}${fleetAMods.boarding}`);
                    if (fleetAMods.damage !== 0) mods.push(`Damage ${fleetAMods.damage > 0 ? '+' : ''}${fleetAMods.damage}`);
                    status += mods.join(', ');
                    if (fleetAMods.reason) status += ` (${fleetAMods.reason})`;
                    status += '</div>';
                }
                
                if (hasFleetBMods) {
                    status += '<div class="text-red-700 font-medium">Fleet B: ';
                    const mods = [];
                    if (fleetBMods.maneuver !== 0) mods.push(`Maneuver ${fleetBMods.maneuver > 0 ? '+' : ''}${fleetBMods.maneuver}`);
                    if (fleetBMods.gunnery !== 0) mods.push(`Gunnery ${fleetBMods.gunnery > 0 ? '+' : ''}${fleetBMods.gunnery}`);
                    if (fleetBMods.boarding !== 0) mods.push(`Boarding ${fleetBMods.boarding > 0 ? '+' : ''}${fleetBMods.boarding}`);
                    if (fleetBMods.damage !== 0) mods.push(`Damage ${fleetBMods.damage > 0 ? '+' : ''}${fleetBMods.damage}`);
                    status += mods.join(', ');
                    if (fleetBMods.reason) status += ` (${fleetBMods.reason})`;
                    status += '</div>';
                }
                
                statusDiv.innerHTML = status;
                statusDiv.className = 'mt-4 text-sm';
            }
        }
        
        function showMessage(message, type = 'info') {
            // Create a temporary message element
            const messageEl = document.createElement('div');
            messageEl.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg shadow-lg transition-all duration-300 ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'warning' ? 'bg-yellow-500 text-black' :
                type === 'error' ? 'bg-red-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            messageEl.textContent = message;
            
            document.body.appendChild(messageEl);
            
            // Remove after 3 seconds
            setTimeout(() => {
                messageEl.style.opacity = '0';
                setTimeout(() => {
                    if (messageEl.parentNode) {
                        messageEl.parentNode.removeChild(messageEl);
                    }
                }, 300);
            }, 3000);
        }

        // GSAP Event listeners and initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize GSAP animations and plugins
            gsap.registerPlugin(ScrollTrigger);
            
            // Animate page elements on load
            gsap.fromTo('.glassmorphism', 
                { opacity: 0, y: 50 },
                { 
                    opacity: 1, 
                    y: 0, 
                    duration: 0.8,
                    stagger: 0.2,
                    ease: "power2.out"
                }
            );
            
            // Animate title
            gsap.fromTo('.gradient-text', 
                { scale: 0.8, opacity: 0 },
                { 
                    scale: 1, 
                    opacity: 1, 
                    duration: 1,
                    ease: "back.out(1.7)"
                }
            );
            
            // Ensure all elements are initialized
            const fleetAList = document.getElementById('fleetAList');
            const fleetBList = document.getElementById('fleetBList');
            const addShipAButton = document.getElementById('addShipA');
            const addShipBButton = document.getElementById('addShipB');
            const simulateBattleButton = document.getElementById('simulateNavalBattle');

            if (!fleetAList || !fleetBList || !addShipAButton || !addShipBButton || !simulateBattleButton) {
                console.error('One or more required elements are missing.');
                return;
            }

            // Reattach event listeners to ensure functionality
            addShipAButton.addEventListener('click', () => {
                console.log('Add Ship A button clicked');
                const shipType = document.getElementById('shipTypeA').value || 'Galley';
                const enhancement = document.getElementById('enhancementA').value || 'None';
                const flag = document.getElementById('flagA').value || 'Royal Navy';
                const count = parseInt(document.getElementById('shipCountA').value) || 1;
                console.log('Input values for Fleet A:', { shipType, enhancement, flag, count });
                if (isNaN(count) || count <= 0) {
                    console.error('Invalid ship count for Fleet A:', count);
                    alert('Please enter a valid ship count (1 or more)');
                    return;
                }
                addShipsToFleet(window.fleetA, fleetAList, shipType, enhancement, flag, count);
            });

            addShipBButton.addEventListener('click', () => {
                console.log('Add Ship B button clicked');
                const shipType = document.getElementById('shipTypeB').value || 'Galley';
                const enhancement = document.getElementById('enhancementB').value || 'None';
                const flag = document.getElementById('flagB').value || 'Pirate Fleet';
                const count = parseInt(document.getElementById('shipCountB').value) || 1;
                console.log('Input values for Fleet B:', { shipType, enhancement, flag, count });
                if (isNaN(count) || count <= 0) {
                    console.error('Invalid ship count for Fleet B:', count);
                    alert('Please enter a valid ship count (1 or more)');
                    return;
                }
                addShipsToFleet(window.fleetB, fleetBList, shipType, enhancement, flag, count);
            });

            simulateBattleButton.addEventListener('click', simulateNavalBattle);

            console.log('Event listeners reattached successfully.');
            
            // GSAP ScrollTrigger for scroll-based animations
            gsap.utils.toArray('.fade-in').forEach(element => {
                gsap.fromTo(element,
                    { opacity: 0, y: 30 },
                    {
                        opacity: 1,
                        y: 0,
                        duration: 0.6,
                        ease: "power2.out",
                        scrollTrigger: {
                            trigger: element,
                            start: "top 85%",
                            toggleActions: "play none none reverse"
                        }
                    }
                );
            });
        });

        // Navigation setup
        fetch('nav.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('nav-placeholder').innerHTML = data;
                
                // Set up mobile menu functionality after nav is loaded
                const mobileMenuButton = document.getElementById('mobile-menu-button');
                const mobileMenu = document.getElementById('mobile-menu');
                if (mobileMenuButton && mobileMenu) {
                    mobileMenuButton.addEventListener('click', () => {
                        if (mobileMenu.classList.contains('hidden')) {
                            mobileMenu.classList.remove('hidden');
                            gsap.fromTo(mobileMenu, 
                                { opacity: 0, y: -20 },
                                { opacity: 1, y: 0, duration: 0.3, ease: "power2.out" }
                            );
                        } else {
                            gsap.to(mobileMenu, {
                                opacity: 0,
                                y: -20,
                                duration: 0.3,
                                ease: "power2.in",
                                onComplete: () => mobileMenu.classList.add('hidden')
                            });
                        }
                    });
                }
                
                // Animate navigation after loading
                gsap.fromTo('nav', 
                    { opacity: 0, y: -50 },
                    { 
                        opacity: 1, 
                        y: 0,
                        duration: 0.8,
                        ease: "power2.out"
                    }
                );
            })
            .catch(error => {
                console.error('Error loading navigation:', error);
                // Fallback - create a simple nav if fetch fails
                document.getElementById('nav-placeholder').innerHTML = `
                    <nav class="bg-white shadow-lg">
                        <div class="container mx-auto px-4">
                            <div class="flex justify-between items-center py-4">
                                <a href="index.html" class="text-xl font-bold text-blue-600">Map Game Mechanics</a>
                                <div class="hidden md:flex space-x-6">
                                    <a href="index.html" class="text-gray-700 hover:text-blue-600">Home</a>
                                    <a href="map.html" class="text-gray-700 hover:text-blue-600">Map</a>
                                    <a href="warfare.html" class="text-gray-700 hover:text-blue-600">Warfare</a>
                                    <a href="battle-simulator.html" class="text-gray-700 hover:text-blue-600">Battle Sim</a>
                                    <a href="navy-battle-simulator.html" class="text-blue-600 font-semibold">Navy Sim</a>
                                </div>
                            </div>
                        </div>
                    </nav>
                `;
            });

    </script>
</body>
</html>
